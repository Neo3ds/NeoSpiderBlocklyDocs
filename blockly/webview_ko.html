<!DOCTYPE html>
<!-- HTML file to host Blockly in a mobile WebView. -->
<html manifest="exam.appcache">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" href="./styles.css">
  <script src="./blockly_compressed.js"></script>
  <script src="./blocks_compressed.js"></script>
  <script src="./acorn_interpreter.js"></script>
  <script src="./javascript_compressed.js"></script>
  <!-- TODO: Select msg file based on locale. -->
  <script src="./modern.js"></script>
  <script src="./msg/js/ko.js"></script>
  <script src="./blocks_edubot.js"></script>
  <script src="./blocks_edubot_generator.js"></script>
  <script src="./toolbox_standard.js"></script>
</head>

<body>
  <div id="blocklyDiv"></div>
  <script type="text/javascript">
        var latestCode = '';
        var intervalRunID = null;
        var myInterpreter = null;

        function delay(ms) {
            let sec = ms * 1000;
            sec += new Date().getTime();
            while (new Date() < sec) { }
        }

        var workspace = Blockly.inject('blocklyDiv', {
            media: 'media/',
            toolbox: BLOCKLY_TOOLBOX_XML['standard'],
            zoom: { controls: true,
                    startScale: 1.0},
            trashcan: true,
            theme: Blockly.Themes.Modern,
        });

        function resetUi() {
            workspace.highlightBlock(null);
        }

        function getXmlTextFromWorkspace() {
            var xml = Blockly.Xml.workspaceToDom(workspace);
            var xml_text = Blockly.Xml.domToText(xml);
            return xml_text;
        }

        function restoreXmlTextToWorkspace(xml_text) {
            Blockly.mainWorkspace.clear();

            var xml = Blockly.Xml.textToDom(xml_text);
            Blockly.Xml.domToWorkspace(xml, workspace);

            Blockly.mainWorkspace.zoomCenter(0);
        }

        function highlightBlock(id) {
            workspace.highlightBlock(id);
        }

        function generateCodeOnly() {
            resetUi();

            if(Blockly.selected != null) {
                Blockly.selected.unselect();
            }

            Blockly.JavaScript.STATEMENT_PREFIX = '';
            code = Blockly.JavaScript.workspaceToCode(workspace);
            return code;
        }

        function generateCodeAndLoadIntoInterpreter() {
            resetUi();

            Blockly.JavaScript.STATEMENT_PREFIX = 'highlightBlock(%1);\n';
            Blockly.JavaScript.addReservedWords('highlightBlock');

            latestCode = Blockly.JavaScript.workspaceToCode(workspace);
        }

        function initApi(interpreter, scope) {
            var wrapper = function(id) {
                id = id ? id.toString() : '';
                return interpreter.createPrimitive(highlightBlock(id));
            };
            interpreter.setProperty(scope, 'highlightBlock', interpreter.createNativeFunction(wrapper));

            var wrapper = function(text) {
                window.alert(arguments.length ? text : '');
                return
            };
            interpreter.setProperty(scope, 'alert', interpreter.createNativeFunction(wrapper));

            var wrapper = function(text) {
                return window.prompt(arguments.length ? text : '');
            };
            interpreter.setProperty(scope, 'prompt', interpreter.createNativeFunction(wrapper));

            /**
             * Move Menu
             */
            // Motor Move
            wrapper = function (motor_move) {
                let state = 0;
                if (motor_move == 'MOVE_FRONT') {
                    state = 1;
                } else if (motor_move == 'MOVE_LEFT') {
                    state = 2;
                } else if (motor_move == 'MOVE_RIGHT') {
                    state = 3;
                } else if (motor_move == 'MOVE_BACKWARD') {
                    state = 4;
                }
                return Android.motorMove(state);
            }
            interpreter.setProperty(scope, 'motor_move', interpreter.createNativeFunction(wrapper));
            
            // Motor Move Secs
            wrapper = function (motor_move, msec) {
                let state = 0;
                if (motor_move == 'MOVE_FRONT') {
                    state = 1;
                } else if (motor_move == 'MOVE_LEFT') {
                    state = 2;
                } else if (motor_move == 'MOVE_RIGHT') {
                    state = 3;
                } else if (motor_move == 'MOVE_BACKWARD') {
                    state = 4;
                }
                Android.motorMove(state);
                delay(msec);
                return Android.motorStop();
            }
            interpreter.setProperty(scope, 'motor_move_secs', interpreter.createNativeFunction(wrapper));

            // Motor Stop
            wrapper = function () {
                return Android.motorStop();
            };
            interpreter.setProperty(scope, 'motor_move_stop', interpreter.createNativeFunction(wrapper));

            // Servo Move
            wrapper = function (direct) {
                let angle = 90;
                if (direct == 'HEAD_LEFT') {
                    angle = 50;
                } else if (direct == 'HEAD_CENTOR') {
                    angle = 90;
                } else if (direct == 'HEAD_RIGHT') {
                    angle = 130;
                }
                return Android.servoAngleMove(angle);
            };
            interpreter.setProperty(scope, 'servo_move', interpreter.createNativeFunction(wrapper));

            // Servo Angle Move
            wrapper = function (angle) {
                return Android.servoAngleMove(angle);
            };
            interpreter.setProperty(scope, 'servo_angle_move', interpreter.createNativeFunction(wrapper));

            // Outer Motor - Digital
            wrapper = function (pin, power) {
                return Android.outerMotor(pin, power);
            };
            interpreter.setProperty(scope, 'outer_motor_digital', interpreter.createNativeFunction(wrapper));

            // Outer Motor - Analog
            wrapper = function (pin, power) {
                return Android.outerMotor(pin, power);
            };
            interpreter.setProperty(scope, 'outer_motor_analog', interpreter.createNativeFunction(wrapper));

            // Delay Time
            wrapper = function (msec) {
                return delay(msec);
            };
            interpreter.setProperty(scope, 'sleep_ms', interpreter.createNativeFunction(wrapper));

            /**
             * Output Menu 
             */
            // Play Tone
            wrapper = function (note, msec) {
                Android.playTone(note);
                delay(msec);
                return Android.playTone(0);
            };
            interpreter.setProperty(scope, 'play_tone', interpreter.createNativeFunction(wrapper));

            // Number LED Color ON
            wrapper = function (number, color) {
                return Android.setNumColorLed(number, color);
            };
            interpreter.setProperty(scope, 'set_num_color_led', interpreter.createNativeFunction(wrapper));
            
            // All LED Color ON
            wrapper = function (color) {
                return Android.setAllColorLed(color)
            }
            interpreter.setProperty(scope, 'set_all_color_led', interpreter.createNativeFunction(wrapper));
            
            // Number LED RGB ON
            wrapper = function (number, red, green, blue) {
                return Android.setNumRgbLed(number, red, green, blue);
            };
            interpreter.setProperty(scope, 'set_num_rgb_led', interpreter.createNativeFunction(wrapper));
            
            // All LED RGB ON
            wrapper = function (red, green, blue) {
                return Android.setAllRgbLed(red, green, blue);
            };
            interpreter.setProperty(scope, 'set_all_rgb_led', interpreter.createNativeFunction(wrapper));

            // All LED OFF
            wrapper = function () {
                return Android.allLedOff();
            };
            interpreter.setProperty(scope, 'all_led_off', interpreter.createNativeFunction(wrapper));
            
            /**
             * Read Menu 
             */
            // Get Analog Data
            wrapper = function (sensorIdx) {
                let idx = 0;
                if (sensorIdx == 'GAS') {
                    idx = 0;
                } else if (sensorIdx == 'CDS') {
                    idx = 1;
                } else if (sensorIdx == 'TEMP') {
                    idx = 2;
                } else if (sensorIdx == 'VIBE') {
                    idx = 3;
                } else if (sensorIdx == 'OUTER') {
                    idx = 0;
                }
                return Android.getAnalogData(idx);
            }
            interpreter.setProperty(scope, 'get_analog_data', interpreter.createNativeFunction(wrapper));

            // Get Mapping Analog Data
            wrapper = function (sensorIdx, transMin, transMax) {
                let idx = 0;
                if (sensorIdx == 'GAS') {
                    idx = 0;
                } else if (sensorIdx == 'CDS') {
                    idx = 1;
                } else if (sensorIdx == 'VIBE') {
                    idx = 3;
                } else if (sensorIdx == 'OUTER') {
                    idx = 0;
                }
                return Android.getMappingAnalogData(idx, transMin, transMax);
            }
            interpreter.setProperty(scope, 'get_mapping_analog_data', interpreter.createNativeFunction(wrapper));

            // Get Ultrasonic Distance
            wrapper = function () {
                return Android.getUltrasonicDistance();
            }
            interpreter.setProperty(scope, 'get_ultrasonic_distance', interpreter.createNativeFunction(wrapper));

            // Get Motion Sensor(Bool)
            wrapper = function () {
                return Android.isMotion();
            } 
            interpreter.setProperty(scope, 'is_motion', interpreter.createNativeFunction(wrapper));

            // Get Infared Left Sensor(Bool)
            wrapper = function () {
                return Android.isInfaredLeft();
            }
            interpreter.setProperty(scope, 'is_infared_left', interpreter.createNativeFunction(wrapper));

            // Get Infared Right Sensor(Bool)
            wrapper = function () {
                return Android.isInfaredRight();
            }
            interpreter.setProperty(scope, 'is_infared_right', interpreter.createNativeFunction(wrapper));
        }

        function runCode() {
            resetUi();

            myInterpreter = new Interpreter(latestCode, initApi);
            intervalRunID = window.setInterval(runCallback, 0);
        }

        function runCallback() {
            var ok = myInterpreter.step();
            if(!Android.allowContinueExecuting() || !ok) {
            // if(!ok) { // Tester
                resetUi();

                window.clearInterval(intervalRunID);
                myInterpreter = null;

                // Android.doneExecuting();
            }
        }
  </script>
</body>
</html>